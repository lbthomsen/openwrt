From 21d106f15262f5a2ef7531636e0703ee61c33c61 Mon Sep 17 00:00:00 2001
From: Sungbo Eo <mans0n@gorani.run>
Date: Sun, 8 Aug 2021 21:38:40 +0900
Subject: [PATCH 2/2] arm: dts: mt7623: add musb device nodes

MT7623 has an musb controller that is compatible with the one from MT2701.

Signed-off-by: Sungbo Eo <mans0n@gorani.run>
---
 arch/arm/boot/dts/mt7623.dtsi  | 34 ++++++++++++++++++++++++++++++++++
 arch/arm/boot/dts/mt7623a.dtsi |  4 ++++
 2 files changed, 38 insertions(+)

Index: linux-5.15.34/arch/arm/boot/dts/mt7623.dtsi
===================================================================
--- linux-5.15.34.orig/arch/arm/boot/dts/mt7623.dtsi
+++ linux-5.15.34/arch/arm/boot/dts/mt7623.dtsi
@@ -585,6 +585,52 @@
 		status = "disabled";
 	};
 
+	usb0: usb@11200000 {
+		compatible = "mediatek,mt7623-musb",
+			     "mediatek,mtk-musb";
+		reg = <0 0x11200000 0 0x1000>;
+		interrupts = <GIC_SPI 32 IRQ_TYPE_LEVEL_LOW>;
+		interrupt-names = "mc";
+		phys = <&u2port2 PHY_TYPE_USB2>;
+		dr_mode = "otg";
+		clocks = <&pericfg CLK_PERI_USB0>,
+			 <&pericfg CLK_PERI_USB0_MCU>,
+			 <&pericfg CLK_PERI_USB_SLV>;
+		clock-names = "main","mcu","univpll";
+		power-domains = <&scpsys MT2701_POWER_DOMAIN_IFR_MSC>;
+		status = "okay";
+                pinctrl-names = "default";
+                pinctrl-0 = <0x22>;
+                usb-role-switch;
+                phandle = <0x8e>;
+
+                connector {
+                        compatible = "gpio-usb-b-connector\0usb-b-connector";
+                        type = "micro";
+                        id-gpios = <0x13 0x2c 0x00>;
+                };
+
+	};
+
+	u2phy1: t-phy@11210000 {
+		compatible = "mediatek,mt7623-tphy",
+			     "mediatek,generic-tphy-v1";
+		reg = <0 0x11210000 0 0x0800>;
+		#address-cells = <2>;
+		#size-cells = <2>;
+		ranges;
+		status = "okay";
+		phandle = <0x8f>;
+
+		u2port2: usb-phy@11210800 {
+			reg = <0 0x11210800 0 0x0100>;
+			clocks = <&topckgen CLK_TOP_USB_PHY48M>;
+			clock-names = "ref";
+			#phy-cells = <1>;
+			status = "okay";
+		};
+	};
+
 	audsys: clock-controller@11220000 {
 		compatible = "mediatek,mt7623-audsys",
 			     "mediatek,mt2701-audsys",
@@ -1263,4 +1309,22 @@
 				 <MT7623_PIN_201_UTXD2_FUNC_UTXD2>;
 		};
 	};
+
+	musb_pins_a: musb {
+		phandle = <0x22>;
+
+		pins-musb {
+			pinmux = <0xed02>;
+		};
+	};
+
+	consys_pins_a: consys_pins_default {
+		phandle = <0x2c>;
+
+		adie {
+			pinmux = <0x3c01 0x3d01 0x3e01 0x3f01 0x4001 0x4101 0x4201 0x4301 0x4401 0x4501 0x4601 0x4701>;
+			bias-disable;
+		};
+	};
+
 };
Index: linux-5.15.34/arch/arm/boot/dts/mt7623a.dtsi
===================================================================
--- linux-5.15.34.orig/arch/arm/boot/dts/mt7623a.dtsi
+++ linux-5.15.34/arch/arm/boot/dts/mt7623a.dtsi
@@ -35,6 +35,10 @@
 	clock-names = "ethif";
 };
 
+&usb0 {
+	power-domains = <&scpsys MT7623A_POWER_DOMAIN_IFR_MSC>;
+};
+
 &usb1 {
 	power-domains = <&scpsys MT7623A_POWER_DOMAIN_HIF>;
 };
Index: linux-5.15.34/arch/arm/boot/dts/mt7623n-bananapi-bpi-r2.dts
===================================================================
--- linux-5.15.34.orig/arch/arm/boot/dts/mt7623n-bananapi-bpi-r2.dts
+++ linux-5.15.34/arch/arm/boot/dts/mt7623n-bananapi-bpi-r2.dts
@@ -140,6 +140,182 @@
 		device_type = "memory";
 		reg = <0 0x80000000 0 0x80000000>;
 	};
+
+        __symbols__ {
+                cpu_opp_table = "/opp-table";
+                cpu0 = "/cpus/cpu@0";
+                cpu1 = "/cpus/cpu@1";
+                cpu2 = "/cpus/cpu@2";
+                cpu3 = "/cpus/cpu@3";
+                system_clk = "/dummy13m";
+                rtc32k = "/oscillator-1";
+                clk26m = "/oscillator-0";
+                cpu_thermal = "/thermal-zones/cpu-thermal";
+                cpu_passive = "/thermal-zones/cpu-thermal/trips/cpu-passive";
+                cpu_active = "/thermal-zones/cpu-thermal/trips/cpu-active";
+                cpu_hot = "/thermal-zones/cpu-thermal/trips/cpu-hot";
+                topckgen = "/syscon@10000000";
+                infracfg = "/syscon@10001000";
+                pericfg = "/syscon@10003000";
+                pio = "/pinctrl@10005000";
+                cir_pins_a = "/pinctrl@10005000/cir-default";
+                i2c0_pins_a = "/pinctrl@10005000/i2c0-default";
+                i2c1_pins_a = "/pinctrl@10005000/i2c1-default";
+                i2c1_pins_b = "/pinctrl@10005000/i2c1-alt";
+                i2c2_pins_a = "/pinctrl@10005000/i2c2-default";
+                i2c2_pins_b = "/pinctrl@10005000/i2c2-alt";
+                i2s0_pins_a = "/pinctrl@10005000/i2s0-default";
+                i2s1_pins_a = "/pinctrl@10005000/i2s1-default";
+                key_pins_a = "/pinctrl@10005000/keys-alt";
+                led_pins_a = "/pinctrl@10005000/leds-alt";
+                mmc0_pins_default = "/pinctrl@10005000/mmc0default";
+                mmc0_pins_uhs = "/pinctrl@10005000/mmc0";
+                mmc1_pins_default = "/pinctrl@10005000/mmc1default";
+                mmc1_pins_uhs = "/pinctrl@10005000/mmc1";
+                nand_pins_default = "/pinctrl@10005000/nanddefault";
+                pcie_default = "/pinctrl@10005000/pcie_pin_default";
+                pwm_pins_a = "/pinctrl@10005000/pwm-default";
+                spi0_pins_a = "/pinctrl@10005000/spi0-default";
+                spi1_pins_a = "/pinctrl@10005000/spi1-default";
+                spi2_pins_a = "/pinctrl@10005000/spi2-default";
+                uart0_pins_a = "/pinctrl@10005000/uart0-default";
+                uart1_pins_a = "/pinctrl@10005000/uart1-default";
+                uart2_pins_a = "/pinctrl@10005000/uart2-default";
+                uart2_pins_b = "/pinctrl@10005000/uart2-alt";
+                hdmi_pins_a = "/pinctrl@10005000/hdmi-default";
+                hdmi_ddc_pins_a = "/pinctrl@10005000/hdmi_ddc-default";
+                musb_pins = "/pinctrl@10005000/musb";
+                consys_pins_default = "/pinctrl@10005000/consys_pins_default";
+                syscfg_pctl_a = "/syscfg@10005000";
+                scpsys = "/power-controller@10006000";
+                watchdog = "/watchdog@10007000";
+                timer = "/timer@10008000";
+                pwrap = "/pwrap@1000d000";
+                pmic = "/pwrap@1000d000/mt6323";
+                mt6323_leds = "/pwrap@1000d000/mt6323/leds";
+                mt6323regulator = "/pwrap@1000d000/mt6323/mt6323regulator";
+                mt6323_vproc_reg = "/pwrap@1000d000/mt6323/mt6323regulator/buck_vproc";
+                mt6323_vsys_reg = "/pwrap@1000d000/mt6323/mt6323regulator/buck_vsys";
+                mt6323_vpa_reg = "/pwrap@1000d000/mt6323/mt6323regulator/buck_vpa";
+                mt6323_vtcxo_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vtcxo";
+                mt6323_vcn28_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcn28";
+                mt6323_vcn33_bt_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcn33_bt";
+                mt6323_vcn33_wifi_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcn33_wifi";
+                mt6323_va_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_va";
+                mt6323_vcama_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcama";
+                mt6323_vio28_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vio28";
+                mt6323_vusb_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vusb";
+                mt6323_vmc_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vmc";
+                mt6323_vmch_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vmch";
+                mt6323_vemc3v3_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vemc3v3";
+                mt6323_vgp1_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vgp1";
+                mt6323_vgp2_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vgp2";
+                mt6323_vgp3_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vgp3";
+                mt6323_vcn18_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcn18";
+                mt6323_vsim1_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vsim1";
+                mt6323_vsim2_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vsim2";
+                mt6323_vrtc_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vrtc";
+                mt6323_vcamaf_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcamaf";
+                mt6323_vibr_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vibr";
+                mt6323_vrf18_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vrf18";
+                mt6323_vm_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vm";
+                mt6323_vio18_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vio18";
+                mt6323_vcamd_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcamd";
+                mt6323_vcamio_reg = "/pwrap@1000d000/mt6323/mt6323regulator/ldo_vcamio";
+                mt6323keys = "/pwrap@1000d000/mt6323/mt6323keys";
+                codec = "/pwrap@1000d000/mt6323/mt6397codec";
+                cir = "/cir@10013000";
+                sysirq = "/interrupt-controller@10200100";
+                efuse = "/efuse@10206000";
+                thermal_calibration_data = "/efuse@10206000/calib@424";
+                apmixedsys = "/syscon@10209000";
+                rng = "/rng@1020f000";
+                gic = "/interrupt-controller@10211000";
+                auxadc = "/adc@11001000";
+                uart2 = "/serial@11004000";
+                uart0 = "/serial@11002000";
+                uart1 = "/serial@11003000";
+                uart3 = "/serial@11005000";
+                pwm = "/pwm@11006000";
+                i2c0 = "/i2c@11007000";
+                i2c1 = "/i2c@11008000";
+                i2c2 = "/i2c@11009000";
+                spi0 = "/spi@1100a000";
+                spidev = "/spi@1100a000/spidev@0";
+                thermal = "/thermal@1100b000";
+                btif = "/serial@1100c000";
+                btif_rx = "/btif_rx@11000800";
+                btif_tx = "/btif_tx@11000780";
+                nandc = "/nfi@1100d000";
+                bch = "/ecc@1100e000";
+                nor_flash = "/spi@11014000";
+                spi1 = "/spi@11016000";
+                spi2 = "/spi@11017000";
+                usb0 = "/usb@11200000";
+                u2phy1 = "/t-phy@11210000";
+                u2port2 = "/t-phy@11210000/usb-phy@11210800";
+                audsys = "/clock-controller@11220000";
+                afe = "/clock-controller@11220000/audio-controller";
+                mmc1 = "/mmc@11240000";
+                mmc0 = "/mmc@11230000";
+                vdecsys = "/syscon@16000000";
+                consys = "/consys@18070000";
+                wifi = "/wifi@180f0000";
+                hifsys = "/syscon@1a000000";
+                pcie = "/pcie@1a140000";
+                pcie0_phy = "/t-phy@1a149000";
+                pcie0_port = "/t-phy@1a149000/pcie-phy@1a149900";
+                pcie1_phy = "/t-phy@1a14a000";
+                pcie1_port = "/t-phy@1a14a000/pcie-phy@1a14a900";
+                usb1 = "/usb@1a1c0000";
+                u3phy1 = "/t-phy@1a1c4000";
+                u2port0 = "/t-phy@1a1c4000/usb-phy@1a1c4800";
+                u3port0 = "/t-phy@1a1c4000/usb-phy@1a1c4900";
+                usb2 = "/usb@1a240000";
+                u3phy2 = "/t-phy@1a244000";
+                u2port1 = "/t-phy@1a244000/usb-phy@1a244800";
+                u3port1 = "/t-phy@1a244000/usb-phy@1a244900";
+                ethsys = "/syscon@1b000000";
+                hsdma = "/dma-controller@1b007000";
+                eth = "/ethernet@1b100000";
+                gmac0 = "/ethernet@1b100000/mac@0";
+                gmac1 = "/ethernet@1b100000/mac@1";
+                mdio = "/ethernet@1b100000/mdio-bus";
+                crypto = "/crypto@1b240000";
+                bdpsys = "/syscon@1c000000";
+                g3dsys = "/syscon@13000000";
+                mali = "/gpu@13040000";
+                mmsys = "/syscon@14000000";
+                larb0 = "/larb@14010000";
+                larb1 = "/larb@16010000";
+                larb2 = "/larb@15001000";
+                imgsys = "/syscon@15000000";
+                iommu = "/mmsys_iommu@10205000";
+                jpegdec = "/jpegdec@15004000";
+                smi_common = "/smi@1000c000";
+                ovl = "/ovl@14007000";
+                rdma0 = "/rdma@14008000";
+                bls = "/pwm@1400a000";
+                color = "/color@1400b000";
+                dsi = "/dsi@1400c000";
+                mutex = "/mutex@1400e000";
+                rdma1 = "/rdma@14012000";
+                dpi0 = "/dpi@14014000";
+                dpi0_out = "/dpi@14014000/ports/port@0/endpoint";
+                hdmi0 = "/hdmi@14015000";
+                hdmi0_in = "/hdmi@14015000/ports/port@0/endpoint";
+                hdmi0_out = "/hdmi@14015000/ports/port@1/endpoint";
+                mipi_tx0 = "/dsi-phy@10010000";
+                cec = "/cec@10012000";
+                hdmi_phy = "/hdmi-phy@10209100";
+                hdmiddc0 = "/i2c@11013000";
+                hdmi_connector_in = "/connector/port/endpoint";
+                reg_1p8v = "/regulator-1p8v";
+                reg_3p3v = "/regulator-3p3v";
+                reg_5v = "/regulator-5v";
+                reg_vgpu = "/fixedregulator@0";
+        };
+
 };
 
 &bls {
